--- origsrc/hamsterdb-2.0.2/src/Makefile.am	2012-04-25 18:42:26.000000000 +0900
+++ src/hamsterdb-2.0.2/src/Makefile.am	2012-04-30 08:55:02.206786500 +0900
@@ -2,11 +2,11 @@
 if ENABLE_REMOTE
 SUBDIRS = protocol
 if ENABLE_SERVER 
-SUBDIRS += server
+SUBDIRS += . server
 endif # ENABLE_SERVER
 endif # ENABLE_REMOTE
 
-AM_CPPFLAGS = -I../include -I$(top_builddir)/3rdparty/aes $(BOOST_CPPFLAGS)
+AM_CPPFLAGS = -I../include -I$(top_builddir)/3rdparty/aes $(BOOST_CPPFLAGS) -I$(top_srcdir)/include
 AM_LDFLAGS = $(BOOST_THREAD_LDFLAGS)
 
 lib_LTLIBRARIES = libhamsterdb.la
@@ -45,7 +45,7 @@ libhamsterdb_la_SOURCES = log.cc \
 			changeset.cc \
 			device.cc
 
-libhamsterdb_la_LDFLAGS = -version-info 3:0:0 -lboost_thread -lpthread 
+libhamsterdb_la_LDFLAGS = -version-info 3:0:0 -lboost_thread-mt -lpthread -no-undefined
 
 if ENABLE_ENCRYPTION
 libhamsterdb_la_LDFLAGS += $(top_builddir)/3rdparty/aes/libaes.la
--- origsrc/hamsterdb-2.0.2/src/journal.cc	2012-04-25 18:42:26.000000000 +0900
+++ src/hamsterdb-2.0.2/src/journal.cc	2012-04-29 23:35:00.690651500 +0900
@@ -12,6 +12,7 @@
 
 #include "config.h"
 
+#include <libgen.h>
 #include <string.h>
 
 #include "db.h"
@@ -780,7 +781,7 @@ Journal::get_path(int i)
 		path+=ext;
 #else
         path+="/";
-        path+=::basename(m_env->get_filename().c_str());
+        path+=::basename(const_cast<char*>(m_env->get_filename().c_str()));
 #endif
     }
     if (i==0)
--- origsrc/hamsterdb-2.0.2/src/log.cc	2012-04-25 18:42:26.000000000 +0900
+++ src/hamsterdb-2.0.2/src/log.cc	2012-04-29 23:32:58.550026500 +0900
@@ -12,6 +12,7 @@
 
 #include "config.h"
 
+#include <libgen.h>
 #include <string.h>
 
 #include "db.h"
@@ -407,7 +408,7 @@ Log::get_path()
 		path+=ext;
 #else
         path+="/";
-		path+=::basename(m_env->get_filename().c_str());
+		path+=::basename(const_cast<char*>(m_env->get_filename().c_str()));
 #endif
     }
     path+=".log0";
--- origsrc/hamsterdb-2.0.2/src/protocol/Makefile.am	2012-04-25 18:42:26.000000000 +0900
+++ src/hamsterdb-2.0.2/src/protocol/Makefile.am	2012-04-29 23:22:52.252422000 +0900
@@ -15,6 +15,6 @@ libprotocol_la_SOURCES = protocol.cc mes
 libprotocol_la_LDFLAGS = -lprotobuf
 
 messages.pb.cc proto: messages.proto
-	protoc messages.proto --cpp_out=.
+	protoc -I$(srcdir) $(srcdir)/messages.proto --cpp_out=.
 	
 
--- origsrc/hamsterdb-2.0.2/src/server/Makefile.am	2012-04-25 18:42:26.000000000 +0900
+++ src/hamsterdb-2.0.2/src/server/Makefile.am	2012-04-30 12:30:30.977354000 +0900
@@ -1,14 +1,15 @@
 
-AM_CPPFLAGS = -I../../include -I.. -I../../3rdparty
+AM_CPPFLAGS = -I../../include -I.. -I../../3rdparty -I$(top_srcdir)/3rdparty -I$(top_srcdir)/include -I$(top_srcdir)/src
 
 lib_LTLIBRARIES = libhamserver.la
 
 libhamserver_la_SOURCES = hamserver.cc os.c
 
-libhamserver_la_LDFLAGS = -version-info 0:0:0
+libhamserver_la_LDFLAGS = -version-info 0:0:0 -no-undefined
 
 libhamserver_la_LDFLAGS += $(top_builddir)/3rdparty/json/libjson.la \
                            $(top_builddir)/3rdparty/mongoose/libmongoose.la \
-                           $(top_builddir)/src/protocol/libprotocol.la
+                           $(top_builddir)/src/protocol/libprotocol.la \
+                           $(top_builddir)/src/libhamsterdb.la
 
 
--- origsrc/hamsterdb-2.0.2/tools/Makefile.am	2012-04-25 18:42:26.000000000 +0900
+++ src/hamsterdb-2.0.2/tools/Makefile.am	2012-04-30 08:57:07.137456700 +0900
@@ -1,6 +1,8 @@
 
 INCLUDES		    = -I$(top_builddir)/include -I$(top_builddir)/src \
-					  -I$(top_builddir)/3rdparty/json
+					  -I$(top_builddir)/3rdparty/json \
+				-I$(top_srcdir)/include \
+				-I$(top_srcdir)/3rdparty/json
 
 hamzilla_SOURCES    = hamzilla.c getopts.c config.c
 hamzilla_LDADD      = $(top_builddir)/src/libhamsterdb.la \
--- origsrc/hamsterdb-2.0.2/tools/hamzilla.c	2012-04-25 18:42:26.000000000 +0900
+++ src/hamsterdb-2.0.2/tools/hamzilla.c	2012-04-30 08:57:38.507556200 +0900
@@ -248,11 +248,13 @@ daemonize(void)
     /* disassociate from process group */
     setpgrp();
 
+#if defined(TIOCNOTTY)
     /* disassociate from control terminal */
     if ((fd=open("dev/tty", O_RDWR)) >= 0) {
         ioctl(fd, TIOCNOTTY, NULL);
         close(fd);
     }
+#endif
 }
 #endif
 
--- origsrc/hamsterdb-2.0.2/unittests/Makefile.am	2012-04-25 18:42:26.000000000 +0900
+++ src/hamsterdb-2.0.2/unittests/Makefile.am	2012-04-30 12:30:57.475400900 +0900
@@ -81,3 +81,5 @@ CXXFLAGS        = $(CFLAGS)
 
 test_recovery:
 	perl recovery.pl
+
+TESTS = test
