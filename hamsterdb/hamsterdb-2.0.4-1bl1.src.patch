--- origsrc/hamsterdb-2.0.4/src/Makefile.am	2012-07-22 04:22:06.000000000 +0900
+++ src/hamsterdb-2.0.4/src/Makefile.am	2012-11-23 12:09:09.417253700 +0900
@@ -1,12 +1,14 @@
 
+SUBDIRS = .
+
 if ENABLE_REMOTE
-SUBDIRS = protocol
+SUBDIRS += protocol
 if ENABLE_SERVER 
 SUBDIRS += server
 endif # ENABLE_SERVER
 endif # ENABLE_REMOTE
 
-AM_CPPFLAGS = -I../include -I$(top_builddir)/3rdparty/aes $(BOOST_CPPFLAGS)
+AM_CPPFLAGS = -I../include -I$(top_builddir)/3rdparty/aes $(BOOST_CPPFLAGS) -I$(top_srcdir)/include
 AM_LDFLAGS = $(BOOST_THREAD_LDFLAGS)
 
 lib_LTLIBRARIES = libhamsterdb.la
@@ -43,7 +45,7 @@ libhamsterdb_la_SOURCES = log.cc \
 			changeset.cc \
 			device.cc
 
-libhamsterdb_la_LDFLAGS = -version-info 3:0:0 $(BOOST_THREAD_LIBS) -lpthread 
+libhamsterdb_la_LDFLAGS = -version-info 3:0:0 $(BOOST_THREAD_LIBS) -lpthread -no-undefined 
 
 if ENABLE_ENCRYPTION
 libhamsterdb_la_LDFLAGS += $(top_builddir)/3rdparty/aes/libaes.la
--- origsrc/hamsterdb-2.0.4/src/protocol/Makefile.am	2012-07-22 04:22:06.000000000 +0900
+++ src/hamsterdb-2.0.4/src/protocol/Makefile.am	2012-11-23 11:58:12.629107200 +0900
@@ -15,6 +15,6 @@ libprotocol_la_SOURCES = protocol.cc mes
 libprotocol_la_LDFLAGS = -lprotobuf
 
 messages.pb.cc proto: messages.proto
-	protoc messages.proto --cpp_out=.
+	protoc -I$(srcdir) $(srcdir)/messages.proto --cpp_out=.
 	
 
--- origsrc/hamsterdb-2.0.4/src/server/Makefile.am	2012-07-22 04:22:06.000000000 +0900
+++ src/hamsterdb-2.0.4/src/server/Makefile.am	2012-11-23 12:06:59.937761500 +0900
@@ -1,14 +1,15 @@
 
-AM_CPPFLAGS = -I../../include -I.. -I../../3rdparty
+AM_CPPFLAGS = -I../../include -I.. -I../../3rdparty -I$(top_srcdir)/3rdparty -I$(top_srcdir)/include -I$(top_srcdir)/src
 
 lib_LTLIBRARIES = libhamserver.la
 
 libhamserver_la_SOURCES = hamserver.cc os.c
 
-libhamserver_la_LDFLAGS = -version-info 0:0:0
+libhamserver_la_LDFLAGS = -version-info 0:0:0 -no-undefined
 
 libhamserver_la_LDFLAGS += $(top_builddir)/3rdparty/json/libjson.la \
                            $(top_builddir)/3rdparty/mongoose/libmongoose.la \
-                           $(top_builddir)/src/protocol/libprotocol.la
+                           $(top_builddir)/src/protocol/libprotocol.la \
+                           $(top_builddir)/src/libhamsterdb.la
 
 
--- origsrc/hamsterdb-2.0.4/tools/Makefile.am	2012-07-22 04:22:06.000000000 +0900
+++ src/hamsterdb-2.0.4/tools/Makefile.am	2012-11-23 12:14:30.597917800 +0900
@@ -1,6 +1,8 @@
 
 INCLUDES		    = -I$(top_builddir)/include -I$(top_builddir)/src \
-					  -I$(top_builddir)/3rdparty/json
+					  -I$(top_builddir)/3rdparty/json \
+				-I$(top_srcdir)/include \
+				-I$(top_srcdir)/3rdparty/json
 
 hamzilla_SOURCES    = hamzilla.c getopts.c config.c
 hamzilla_LDADD      = $(top_builddir)/src/libhamsterdb.la \
--- origsrc/hamsterdb-2.0.4/tools/hamzilla.c	2012-07-22 04:22:06.000000000 +0900
+++ src/hamsterdb-2.0.4/tools/hamzilla.c	2012-11-23 12:13:22.285417800 +0900
@@ -248,11 +248,13 @@ daemonize(void)
     /* disassociate from process group */
     setpgrp();
 
+#if defined(TIOCNOTTY)
     /* disassociate from control terminal */
     if ((fd=open("dev/tty", O_RDWR)) >= 0) {
         ioctl(fd, TIOCNOTTY, NULL);
         close(fd);
     }
+#endif
 }
 #endif
 
--- origsrc/hamsterdb-2.0.4/unittests/Makefile.am	2012-07-22 04:22:06.000000000 +0900
+++ src/hamsterdb-2.0.4/unittests/Makefile.am	2012-11-23 15:24:33.270988400 +0900
@@ -2,6 +2,7 @@
 EXTRA_DIST      = suppressions.valgrind
 
 noinst_PROGRAMS = test bfc_sample recovery
+TESTS           = test bfc_sample recovery
 
 AM_CPPFLAGS     = -I$(top_builddir)/include
 
